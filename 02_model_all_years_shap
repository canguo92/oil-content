#!/usr/bin/env Rscript
# ------------------------------------------------------------------------------
# 02_model_all_years_shap.R
# 全年份：建模 (LOYO) + SHAP 归因 + 全局/逐年可视化 + 反事实恢复（GitHub 版）
# 输出遵循既有命名：B0/B1/B2/.../B11；图存 B_outputs/plots/
# ------------------------------------------------------------------------------

suppressPackageStartupMessages({
  pkgs <- c("readr","dplyr","tidyr","stringr","purrr","ggplot2","xgboost",
            "Matrix","cowplot","scales","optparse")
  to_install <- pkgs[!pkgs %in% installed.packages()[,1]]
  if (length(to_install)) install.packages(to_install, repos = "https://cloud.r-project.org")
  library(readr); library(dplyr); library(tidyr); library(stringr); library(purrr)
  library(ggplot2); library(xgboost); library(Matrix); library(cowplot); library(scales)
  library(optparse)
})

# ---------------- CLI 参数 ----------------
option_list <- list(
  make_option("--input",  type="character", help="输入 CSV（含 grow_year/Province/City/County 与气象特征）"),
  make_option("--outdir", type="character", help="输出根目录（默认：与 input 同目录下 B_outputs）", default=NULL),
  make_option("--target_col", type="character", default="Oil content", help='目标列名，默认 "Oil content"'),
  make_option("--feature_cols", type="character", default="10:108",
              help='特征列：形如 "10:108"（索引范围）或列名逗号表 "f1,f2,..."'),
  make_option("--seed", type="integer", default=20251009, help="随机种子，默认 20251009"),
  make_option("--rounds", type="integer", default=800, help="xgboost 迭代轮次，默认 800"),
  make_option("--max_depth", type="integer", default=4, help="xgboost max_depth，默认 4"),
  make_option("--eta", type="double", default=0.05, help="xgboost eta，默认 0.05"),
  make_option("--subsample", type="double", default=0.8, help="xgboost subsample，默认 0.8"),
  make_option("--colsample", type="double", default=0.8, help="xgboost colsample_bytree，默认 0.8"),
  make_option("--threads", type="integer", default=0, help="xgboost 线程；0=auto"),
  make_option("--focus_years", type="character", default="2012,2016,2019,2021,2023",
              help='重点年份（用于反事实默认年）：逗号分隔'),
  make_option("--cf_year", type="character", default="auto",
              help='反事实年份："auto" 用 focus_years 最大值；或指定年份，如 "2023"'),
  make_option("--cf_topk", type="integer", default=3, help="反事实 Top-K 恢复，默认 3"),
  make_option("--violin_topk", type="integer", default=8, help="小提琴面板按各年 Top-K 因子展示，默认 8")
)
args <- parse_args(OptionParser(option_list = option_list))
stopifnot(!is.null(args$input), file.exists(args$input))

# ---------------- 路径与基本设置 ----------------
infile  <- normalizePath(args$input, winslash = "/", mustWork = TRUE)
root_dir<- dirname(infile)
out_dir <- if (is.null(args$outdir)) file.path(root_dir, "B_outputs") else args$outdir
plots_dir <- file.path(out_dir, "plots")
dir.create(out_dir, showWarnings = FALSE, recursive = TRUE)
dir.create(plots_dir, showWarnings = FALSE, recursive = TRUE)

TARGET_COL   <- args$target_col
SEED         <- args$seed
set.seed(SEED)

# ---------------- Reader ----------------
robust_read_csv <- function(path){
  for (enc in c("GB18030","UTF-8","UTF-8-BOM","GBK","latin1")){
    x <- try(readr::read_csv(path, locale=readr::locale(encoding=enc), show_col_types=FALSE), silent=TRUE)
    if(!inherits(x,"try-error")) return(x)
  }; stop("Failed to read file. Please check path or encoding.")
}
raw <- robust_read_csv(infile); names(raw) <- trimws(names(raw))
if (!"Region" %in% names(raw)) raw$Region <- raw$Province

# 解析特征列
parse_feature_spec <- function(df, spec){
  spec <- trimws(spec)
  if (grepl("^\\d+\\s*:\\s*\\d+$", spec)) {
    r <- as.integer(strsplit(gsub("\\s","",spec), ":")[[1]])
    stopifnot(length(r)==2, r[2] <= ncol(df))
    return(names(df)[r[1]:r[2]])
  } else {
    items <- strsplit(spec, ",")[[1]] |> trimws()
    miss  <- setdiff(items, names(df))
    if (length(miss)) stop("feature_cols 中以下列名不存在：", paste(miss, collapse=", "))
    return(items)
  }
}
feature_cols <- parse_feature_spec(raw, args$feature_cols)

stopifnot(all(c("Province","City","County","grow_year", TARGET_COL) %in% names(raw)))
raw[[TARGET_COL]] <- suppressWarnings(as.numeric(raw[[TARGET_COL]]))

# ---------------- 目标构造：县年均值 -> 县内去趋势 -> 年去均值 ----------------
cy_mean <- raw %>%
  group_by(Province, City, County, grow_year) %>%
  summarise(y_val = mean(.data[[TARGET_COL]], na.rm=TRUE), .groups="drop")

fit_trend_1series <- function(d){
  d <- arrange(d, grow_year)
  ok <- is.finite(d$y_val) & is.finite(d$grow_year)
  out <- d; out$trend <- NA_real_; out$resid <- NA_real_
  n_ok <- sum(ok); nyrs <- dplyr::n_distinct(d$grow_year[ok])
  if (n_ok == 0) { out$method <- "no_data"; out$nyrs <- 0; return(out) }
  if (n_ok == 1) {
    mu <- d$y_val[ok]; out$trend[ok] <- mu; out$resid[ok] <- d$y_val[ok]-mu
    out$method <- "mean_only_1pt"; out$nyrs <- 1; return(out)
  }
  zt <- as.numeric(scale(d$grow_year[ok], center=TRUE, scale=TRUE))
  y  <- d$y_val[ok]
  span <- max(0.55, min(0.90, 5/nyrs + 0.35))
  pr <- try({ suppressWarnings(predict(loess(y ~ zt, span=span, degree=1,
                                             family="symmetric",
                                             control=loess.control(surface="direct", trace.hat="approx")))) }, silent=TRUE)
  method <- "loess"
  if (inherits(pr, "try-error") || any(!is.finite(pr)) || nyrs < 5) {
    pr <- as.numeric(predict(lm(y ~ zt))); method <- "linear"
  }
  out$trend[ok] <- pr; out$resid[ok] <- y - pr; out$method <- method; out$nyrs <- nyrs
  out
}
cy_detr <- cy_mean %>% group_by(Province, City, County) %>%
  group_modify(~fit_trend_1series(.x)) %>% ungroup()

year_eq <- cy_detr %>% group_by(grow_year) %>%
  summarise(mu_year_eq = mean(resid, na.rm=TRUE), .groups="drop")

target <- cy_detr %>% left_join(year_eq, by="grow_year") %>%
  transmute(grow_year, Province, City, County, y = resid - mu_year_eq)

# ---------------- 特征：县-年均值 ----------------
feat_cy <- raw %>%
  group_by(Province, City, County, grow_year) %>%
  summarise(across(all_of(feature_cols), ~mean(suppressWarnings(as.numeric(.x)), na.rm=TRUE)), .groups="drop")

dat <- target %>% inner_join(feat_cy, by=c("Province","City","County","grow_year"))
years <- sort(unique(dat$grow_year))

# ---------------- 折构造（县基线异常化 + 折内标准化） ----------------
mk_fold_mats <- function(test_year){
  train <- dat %>% filter(grow_year != test_year)
  test  <- dat %>% filter(grow_year == test_year)
  base_train <- train %>%
    group_by(Province, City, County) %>%
    summarise(across(all_of(feature_cols), ~mean(.x, na.rm=TRUE)), .groups="drop")
  train2 <- train %>% left_join(base_train, by=c("Province","City","County"), suffix = c("", "_base"))
  test2  <- test  %>% left_join(base_train, by=c("Province","City","County"),  suffix = c("", "_base"))
  for (fc in feature_cols){
    base_col <- paste0(fc, "_base")
    glob_base <- mean(train2[[fc]], na.rm=TRUE)
    test2[[base_col]][is.na(test2[[base_col]])]  <- glob_base
    train2[[base_col]][is.na(train2[[base_col]])]<- glob_base
    train2[[fc]] <- train2[[fc]] - train2[[base_col]]
    test2[[fc]]  <- test2[[fc]]  - test2[[base_col]]
  }
  sds <- sapply(feature_cols, function(fc) sd(train2[[fc]], na.rm=TRUE))
  sds[sds==0 | !is.finite(sds)] <- 1
  for (fc in feature_cols){
    train2[[fc]] <- train2[[fc]] / sds[fc]
    test2[[fc]]  <- test2[[fc]]  / sds[fc]
    med <- median(train2[[fc]], na.rm=TRUE); if (!is.finite(med)) med <- 0
    train2[[fc]][!is.finite(train2[[fc]])] <- med
    test2[[fc]][!is.finite(test2[[fc]])]   <- med
  }
  list(train=train2, test=test2)
}

# ---------------- 公版主题/保存 ----------------
nature_theme_light <- function(base_size = 11, base_family = "Arial"){
  theme_classic(base_size = base_size, base_family = base_family) %+replace%
    theme(legend.position="right",
          axis.title.x = element_text(size = base_size + 1, margin = margin(6,0,0,0)),
          axis.title.y = element_text(size = base_size + 1, angle = 90, vjust = 0.5, hjust = 0.5,
                                      margin = margin(0, 2, 0, 0)),
          axis.ticks    = element_line(linewidth = 0.3),
          axis.line     = element_line(linewidth = 0.5),
          panel.grid.major = element_line(color = "grey92", linewidth = 0.3),
          panel.grid.minor = element_blank())
}
save_figure_pub <- function(p, filename_base, width=7.0, height=4.2, dpi=600){
  png_path  <- file.path(plots_dir, paste0(filename_base, ".png"))
  tiff_path <- file.path(plots_dir, paste0(filename_base, ".tiff"))
  dir.create(dirname(png_path), showWarnings = FALSE, recursive = TRUE)
  suppressWarnings(unlink(c(png_path, tiff_path), force=TRUE))
  ggplot2::ggsave(png_path, p, width=width, height=height, dpi=300)
  grDevices::tiff(filename = tiff_path, width = width, height = height,
                  units = "in", res = dpi, compression = "lzw")
  print(p); grDevices::dev.off()
}

# ---------------- 训练（LOYO 全年） + SHAP（保存所有年） ----------------
XGB_PARAMS <- list(
  objective="reg:squarederror",
  max_depth=as.integer(args$max_depth),
  eta=as.numeric(args$eta),
  subsample=as.numeric(args$subsample),
  colsample_bytree=as.numeric(args$colsample),
  nthread=as.integer(args$threads),
  min_child_weight=1, lambda=1
)
NROUNDS <- as.integer(args$rounds)

all_shap_long <- list()
perfold_perf  <- list()
preds_all     <- list()

for (yr in years){
  fold <- mk_fold_mats(yr)
  tr <- fold$train; te <- fold$test
  X_tr <- as.matrix(tr[, feature_cols]); y_tr <- tr$y
  X_te <- as.matrix(te[, feature_cols]); y_te <- te$y
  dtr  <- xgb.DMatrix(data=X_tr, label=y_tr)
  dte  <- xgb.DMatrix(data=X_te, label=y_te)

  bst <- xgb.train(params=XGB_PARAMS, data=dtr, nrounds=NROUNDS, verbose=0)

  # 性能
  pred_te <- predict(bst, dte)
  rmse <- sqrt(mean((pred_te - y_te)^2))
  r2   <- if (sd(y_te)>0) cor(pred_te, y_te)^2 else NA_real_
  perfold_perf[[as.character(yr)]] <- data.frame(grow_year=yr, RMSE=rmse, R2=r2, n=nrow(te))

  # 预测记录
  preds_all[[as.character(yr)]] <- tibble(grow_year=yr,
    Province=te$Province, City=te$City, County=te$County,
    y_true=y_te, y_pred=pred_te, resid=y_te - pred_te)

  # SHAP
  shap <- predict(bst, dte, predcontrib = TRUE)
  colnames(shap) <- c(feature_cols, "BIAS")
  shap <- shap[, feature_cols, drop=FALSE]
  shap_long <- as.data.frame(shap) %>%
    mutate(row_id = seq_len(n())) %>%
    cbind(te[, c("grow_year","Province","City","County")]) %>%
    tidyr::pivot_longer(cols = all_of(feature_cols),
                        names_to="feature", values_to="shap_value")
  readr::write_csv(shap_long, file.path(out_dir, sprintf("B1_SHAP_long_%d.csv", yr)))
  all_shap_long[[as.character(yr)]] <- shap_long
}
perf_all <- bind_rows(perfold_perf)
write_csv(perf_all, file.path(out_dir, "B0_LOYO_perf_xgb.csv"))
preds_tbl <- bind_rows(preds_all)
write_csv(preds_tbl, file.path(out_dir, "B0_LOYO_predictions.csv"))

# ---------------- 归因汇总：年/省/县 × feature ----------------
shap_all <- bind_rows(all_shap_long, .id="year_str") %>%
  mutate(grow_year = as.integer(year_str)) %>% select(-year_str)

year_feat <- shap_all %>%
  group_by(grow_year, feature) %>%
  summarise(
    mean_shap = mean(shap_value, na.rm=TRUE),
    neg_sum   = sum(shap_value[shap_value < 0], na.rm=TRUE),
    neg_mean  = mean(shap_value[shap_value < 0], na.rm=TRUE),
    pos_sum   = sum(shap_value[shap_value > 0], na.rm=TRUE),
    n = dplyr::n(), .groups="drop"
  )
write_csv(year_feat, file.path(out_dir, "B2_year_feature_SHAP.csv"))

prov_feat <- shap_all %>%
  group_by(grow_year, Province, feature) %>%
  summarise(mean_shap = mean(shap_value, na.rm=TRUE),
            neg_sum   = sum(shap_value[shap_value < 0], na.rm=TRUE),
            n = dplyr::n(), .groups="drop")
write_csv(prov_feat, file.path(out_dir, "B3_year_province_feature_SHAP.csv"))

county_feat <- shap_all %>%
  group_by(grow_year, Province, City, County, feature) %>%
  summarise(mean_shap = mean(shap_value, na.rm=TRUE),
            neg_sum   = sum(shap_value[shap_value < 0], na.rm=TRUE),
            n = dplyr::n(), .groups="drop")
write_csv(county_feat, file.path(out_dir, "B4_year_county_feature_SHAP.csv"))

# ---------------- 物理家族映射（无 Others，确保覆盖） ----------------
grp_pal <- c(
  "Thermal (heat)"  = "#E41A1C",
  "Cold stress"     = "#377EB8",
  "Moisture"        = "#4DAF4A",
  "Radiation"       = "#984EA3",
  "Wind"            = "#FF7F00",
  "Humidity"        = "#A65628"
)
assign_feature_group_no_others <- function(features){
  f_low <- tolower(features)
  group <- rep(NA_character_, length(features))
  cold_pat <- "(^|[_])tnn($|_)|(^|[_])fdd($|_)|(^|[_])fd($|_)|cold|frost|chill|freeze|freezing|low\\s*temp|cold\\s*spell"
  group[grepl(cold_pat, f_low, perl=TRUE)] <- "Cold stress"
  heat_pat <- "gdd|edd|(^|[_])txx($|_)|etr|temp|tmean|tmax|meant|maxt|mint|hot|warm|growing\\.degree|gsl|dtr|accum"
  group[is.na(group) & grepl(heat_pat, f_low, perl=TRUE)] <- "Thermal (heat)"
  moist_pat <- "precip|\\brx1day\\b|\\brx5day\\b|\\br10\\b|\\br20\\b|r95|sdii|\\bcdd\\b|\\bcwd\\b|spei|spi|pdsi|smdi|drought|wet|dry|\\bevap\\b|evapo|et0|pet|aet|eta|\\bvpd\\b|soil.*moist|\\bsm(\\b|_)|swc|theta|snow"
  group[is.na(group) & grepl(moist_pat, f_low, perl=TRUE)] <- "Moisture"
  rad_pat <- "solarrad|\\bsrad\\b|\\brad\\b|shortwave|rsds|sunshine|\\bsun\\b|insol|\\bpar\\b|cloud"
  group[is.na(group) & grepl(rad_pat, f_low, perl=TRUE)] <- "Radiation"
  hum_pat <- "humidity|\\brh\\b|relative.*humidity|vapor\\s*press|\\bvp\\b"
  group[is.na(group) & grepl(hum_pat, f_low, perl=TRUE)] <- "Humidity"
  wind_pat <- "\\bwind\\b|wind(_|\\s)?speed|\\bws\\b|\\bu10\\b|\\bv10\\b"
  group[is.na(group) & grepl(wind_pat, f_low, perl=TRUE)] <- "Wind"
  group[is.na(group) | group==""] <- "Thermal (heat)"
  data.frame(feature = features, group = group, stringsAsFactors = FALSE)
}
feature_group_map <- assign_feature_group_no_others(feature_cols)

override_fp <- file.path(out_dir, "B0_meteorological_feature_groups_override.csv")
if (file.exists(override_fp)) {
  override <- readr::read_csv(override_fp, show_col_types = FALSE) %>%
    dplyr::mutate(feature = as.character(feature), group = as.character(group))
  feature_group_map <- feature_group_map %>%
    dplyr::left_join(override, by="feature", suffix = c("", "_ovr")) %>%
    dplyr::mutate(group = dplyr::coalesce(group_ovr, group)) %>%
    dplyr::select(feature, group)
}
write_csv(feature_group_map, file.path(out_dir, "B0_meteorological_feature_groups.csv"))

# ---------------- Top-10 与 家族汇总（逐年） ----------------
plot_top10_en <- function(year_feat, yr, group_map = feature_group_map){
  sub <- year_feat %>% dplyr::filter(grow_year==yr) %>%
    dplyr::left_join(group_map, by="feature") %>%
    dplyr::arrange(neg_sum)
  k <- min(10, nrow(sub)); if (k==0) return(invisible(NULL))
  sub <- sub %>% dplyr::slice_head(n = k)
  p <- ggplot(sub, aes(x = reorder(feature, neg_sum), y = neg_sum, fill = group)) +
    geom_col(width = 0.7) + coord_flip() +
    scale_fill_manual(values = grp_pal, drop = TRUE) +
    labs(x = "Meteorological feature",
         y = "Sum of negative SHAP contributions (more negative = stronger decline driver)",
         fill = "Physical group") +
    nature_theme_light(base_size = 11)
  save_figure_pub(p, sprintf("B5_top10_features_%d_grouped", yr), width=7.2, height=4.6, dpi=600)
}
plot_group_summary <- function(year_feat, yr, group_map = feature_group_map){
  sub <- year_feat %>% filter(grow_year==yr) %>%
    left_join(group_map, by="feature") %>%
    group_by(group) %>% summarise(neg_sum = sum(neg_sum, na.rm=TRUE), .groups="drop") %>%
    arrange(neg_sum)
  p <- ggplot(sub, aes(x = reorder(group, neg_sum), y = neg_sum, fill = group)) +
    geom_col(width = 0.7) + coord_flip() +
    scale_fill_manual(values = grp_pal, guide = "none") +
    labs(x = "Physical group", y = "Sum of negative SHAP contributions") +
    nature_theme_light(base_size = 11)
  save_figure_pub(p, sprintf("B10_group_summary_%d", yr), width=6.4, height=4.2, dpi=600)
}
for (yr in unique(year_feat$grow_year)){
  plot_top10_en(year_feat, yr)
  plot_group_summary(year_feat, yr)
}

# ---------------- 全局共识因子与家族份额 ----------------
global_imp <- shap_all %>%
  group_by(feature) %>%
  summarise(
    mean_abs_shap = mean(abs(shap_value), na.rm = TRUE),
    neg_sum       = sum(pmin(shap_value, 0), na.rm = TRUE),
    pos_sum       = sum(pmax(shap_value, 0), na.rm = TRUE),
    n             = dplyr::n(), .groups = "drop"
  ) %>%
  arrange(desc(mean_abs_shap)) %>%
  left_join(feature_group_map, by="feature") %>%
  mutate(group = ifelse(is.na(group) | group=="", "Thermal (heat)", group))
write_csv(global_imp, file.path(out_dir, "B8_global_SHAP_importance_all_years.csv"))

fam_share_shap_abs <- global_imp %>%
  group_by(group) %>% summarise(share = sum(mean_abs_shap, na.rm=TRUE), .groups="drop") %>%
  mutate(share = share / sum(share)) %>% arrange(desc(share))
write_csv(fam_share_shap_abs, file.path(out_dir, "B9_family_share_global_meanAbsSHAP.csv"))

fam_share_neg_sum <- global_imp %>%
  group_by(group) %>% summarise(neg_total = -sum(neg_sum, na.rm=TRUE), .groups="drop") %>%
  mutate(share = ifelse(sum(neg_total) > 0, neg_total / sum(neg_total), NA_real_)) %>%
  arrange(desc(share))
write_csv(fam_share_neg_sum, file.path(out_dir, "B9_family_share_global_negativeSHAP.csv"))

K <- 10
yearly_topk <- year_feat %>%
  group_by(grow_year) %>% arrange(neg_sum) %>% slice_head(n = min(K, n())) %>% ungroup() %>%
  count(feature, name = "appear_years") %>% arrange(desc(appear_years))
write_csv(yearly_topk, file.path(out_dir, sprintf("B11_yearly_top%d_frequency.csv", K)))

p_global_top20 <- global_imp %>%
  slice_max(order_by = mean_abs_shap, n = min(20, n())) %>%
  mutate(feature = forcats::fct_reorder(feature, mean_abs_shap)) %>%
  ggplot(aes(x = feature, y = mean_abs_shap, fill = group)) +
  geom_col() + coord_flip() +
  scale_fill_manual(values = grp_pal, drop = TRUE) +
  labs(x = "Meteorological feature (global)",
       y = "Mean |SHAP| across all LOYO test folds (p.p.)",
       fill = "Physical group") +
  nature_theme_light(base_size = 11)
save_figure_pub(p_global_top20, "B8_global_importance_top20", width=7.2, height=5.0, dpi=600)

p_fam_abs <- fam_share_shap_abs %>%
  mutate(group = forcats::fct_reorder(group, share)) %>%
  ggplot(aes(x = group, y = share, fill = group)) +
  geom_col() + coord_flip() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(values = grp_pal, guide = "none") +
  labs(x = "Physical group", y = "Share of mean |SHAP| (global)") +
  nature_theme_light(base_size = 11)
save_figure_pub(p_fam_abs, "B9_family_share_global_meanAbsSHAP", width=6.2, height=4.0, dpi=600)

p_fam_neg <- fam_share_neg_sum %>%
  mutate(group = forcats::fct_reorder(group, share)) %>%
  ggplot(aes(x = group, y = share, fill = group)) +
  geom_col() + coord_flip() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(values = grp_pal, guide = "none") +
  labs(x = "Physical group", y = "Share of negative SHAP (global)") +
  nature_theme_light(base_size = 11)
save_figure_pub(p_fam_neg, "B9_family_share_global_negativeSHAP", width=6.2, height=4.0, dpi=600)

# ---------------- 多年面板（Top10/Group/Violin） ----------------
wrap_with_year_header <- function(p, year_lab, header_height = 0.12, header_size = 9){
  header <- ggdraw() + theme(plot.margin = margin(0,0,0,0)) +
    draw_label(as.character(year_lab), x = 0.02, y = 0.5, hjust = 0, vjust = 0.5,
               fontface = "bold", size = header_size)
  plot_grid(header, p + theme(plot.title = element_blank()), ncol = 1,
            rel_heights = c(header_height, 1), align = "v")
}
grid_dims <- function(n){ ncol <- ceiling(sqrt(n)); nrow <- ceiling(n / ncol); list(ncol = ncol, nrow = nrow) }
panel_size <- function(ncol, nrow, tile_w = 3.4, tile_h = 3.0){ list(width = ncol * tile_w, height = nrow * tile_h) }

make_top10_plot_year <- function(yr, year_feat_tbl = year_feat, group_map = feature_group_map){
  sub <- year_feat_tbl %>% filter(grow_year == yr) %>% left_join(group_map, by="feature") %>% arrange(neg_sum)
  if (nrow(sub) == 0) return(NULL)
  sub <- slice_head(sub, n = min(10, nrow(sub)))
  ggplot(sub, aes(x = reorder(feature, neg_sum), y = neg_sum, fill = group)) +
    geom_col(width = 0.7) + coord_flip() +
    scale_fill_manual(values = grp_pal, drop = TRUE) +
    labs(x = "Meteorological feature", y = "Sum of negative SHAP contributions", fill = "Physical group") +
    nature_theme_light(base_size = 10) + theme(legend.position = "none")
}
make_group_summary_year <- function(yr, year_feat_tbl = year_feat, group_map = feature_group_map){
  sub <- year_feat_tbl %>% filter(grow_year == yr) %>%
    left_join(group_map, by="feature") %>%
    group_by(group) %>% summarise(neg_sum = sum(neg_sum, na.rm = TRUE), .groups = "drop") %>% arrange(neg_sum)
  if (nrow(sub) == 0) return(NULL)
  ggplot(sub, aes(x = reorder(group, neg_sum), y = neg_sum, fill = group)) +
    geom_col(width = 0.7) + coord_flip() +
    scale_fill_manual(values = grp_pal, drop = TRUE) +
    labs(x = "Physical group", y = "Sum of negative SHAP contributions") +
    nature_theme_light(base_size = 10) + theme(legend.position = "none")
}
make_violin_year <- function(yr, shap_tbl_all = shap_all, topK = args$violin_topk, group_map = feature_group_map){
  suby <- shap_tbl_all %>% filter(grow_year == yr) %>% left_join(group_map, by = "feature")
  if (nrow(suby) == 0) return(NULL)
  agg <- suby %>% group_by(feature, group) %>%
    summarise(neg_sum = sum(shap_value[shap_value < 0], na.rm = TRUE), .groups = "drop") %>%
    arrange(neg_sum)
  topk <- agg %>% slice_head(n = min(topK, nrow(agg))) %>% pull(feature)
  show <- suby %>% filter(feature %in% topk)
  ggplot(show, aes(x = reorder(feature, shap_value, FUN = median), y = shap_value, fill = group)) +
    geom_violin(color = "grey60", scale = "width", alpha = 0.9) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "grey50", linewidth = 0.4) +
    stat_summary(fun = median, geom = "point", shape = 21, size = 2, fill = "white") +
    coord_flip() + scale_fill_manual(values = grp_pal, drop = TRUE) +
    labs(x = "Meteorological feature (Top drivers)", y = "SHAP value (p.p.)") +
    nature_theme_light(base_size = 10) + theme(legend.position = "none")
}
assemble_all_years_panel <- function(make_one_fun, years_vec, filename_stub,
                                     header_height = 0.14, header_size = 9,
                                     tile_w = 3.4, tile_h = 3.0){
  plist <- lapply(years_vec, function(yr){
    p <- make_one_fun(yr); if (is.null(p)) return(NULL)
    wrap_with_year_header(p, yr, header_height = header_height, header_size = header_size)
  })
  plist <- Filter(Negate(is.null), plist)
  if (length(plist) == 0) return(invisible(NULL))
  dims <- grid_dims(length(plist)); size <- panel_size(dims$ncol, dims$nrow, tile_w = tile_w, tile_h = tile_h)
  panel <- cowplot::plot_grid(plotlist = plist, ncol = dims$ncol,
                              labels = letters[seq_len(length(plist))],
                              label_size = 12, label_fontface = "bold",
                              label_x = 0.01, label_y = 0.995, hjust = 0, vjust = 1)
  save_figure_pub(panel, filename_base = filename_stub, width = size$width, height = size$height, dpi = 600)
}
years_all <- sort(unique(year_feat$grow_year))
assemble_all_years_panel(function(yr) make_top10_plot_year(yr, year_feat),
                         years_all, "B5_top10_features_panel_ALL_YEARS",
                         tile_w = 3.4, tile_h = 3.0)
assemble_all_years_panel(function(yr) make_group_summary_year(yr, year_feat),
                         years_all, "B10_group_summary_panel_ALL_YEARS",
                         tile_w = 3.2, tile_h = 2.8)
assemble_all_years_panel(function(yr) make_violin_year(yr, shap_all, topK = args$violin_topk),
                         years_all, "B7_beeswarm_panel_ALL_YEARS",
                         tile_w = 3.6, tile_h = 3.2)

# ---------------- 反事实恢复（Top-K -> 回到县基线） ----------------
focus_years <- as.integer(strsplit(args$focus_years, ",")[[1]])
cf_year <- if (tolower(args$cf_year)=="auto") max(focus_years, na.rm=TRUE) else as.integer(args$cf_year)

counterfactual_restore <- function(test_year, topK_features = 3, which_counties = NULL){
  fold <- mk_fold_mats(test_year)
  tr <- fold$train; te <- fold$test
  X_tr <- as.matrix(tr[, feature_cols]); y_tr <- tr$y
  X_te <- as.matrix(te[, feature_cols]); y_te <- te$y
  dtr <- xgb.DMatrix(data=X_tr, label=y_tr)
  bst <- xgb.train(params=XGB_PARAMS, data=dtr, nrounds=NROUNDS, verbose=0)
  shap <- predict(bst, xgb.DMatrix(X_te), predcontrib=TRUE)
  colnames(shap) <- c(feature_cols, "BIAS")
  shap <- shap[, feature_cols, drop=FALSE]
  te2 <- te %>% mutate(.rid = row_number())
  if (!is.null(which_counties)) te2 <- te2 %>% semi_join(which_counties, by=c("Province","City","County"))
  rows <- te2$.rid
  X_cf <- X_te
  for (r in rows){
    v <- shap[r, ]
    feat_ord <- names(sort(v, decreasing = FALSE))  # 最负向优先
    take <- feat_ord[seq_len(min(topK_features, length(feat_ord)))]
    X_cf[r, take] <- 0  # 回到折内“县基线异常=0”
  }
  pred_obs <- predict(bst, xgb.DMatrix(X_te))
  pred_cf  <- predict(bst, xgb.DMatrix(X_cf))
  out <- te %>% mutate(pred_obs = pred_obs, pred_cf = pred_cf, restore = pred_cf - pred_obs) %>% arrange(desc(restore))
  out
}
if (!is.na(cf_year) && (cf_year %in% years)){
  cf_res  <- counterfactual_restore(cf_year, topK_features = as.integer(args$cf_topk))
  cf_by_prov <- cf_res %>%
    group_by(Province) %>%
    summarise(mean_restore = mean(restore, na.rm=TRUE),
              sum_restore  = sum(restore, na.rm=TRUE),
              n = dplyr::n(), .groups="drop") %>%
    arrange(desc(sum_restore))
  write_csv(cf_by_prov, file.path(out_dir, sprintf("B6_counterfactual_%d_by_province.csv", cf_year)))
  keymap <- raw %>% distinct(Province, City, County, Region)
  cf_with_reg <- cf_res %>% left_join(keymap, by=c("Province","City","County"))
  cf_by_reg <- cf_with_reg %>%
    group_by(Region) %>%
    summarise(mean_restore = mean(restore, na.rm=TRUE),
              sum_restore  = sum(restore, na.rm=TRUE),
              n = dplyr::n(), .groups="drop") %>%
    arrange(desc(sum_restore))
  write_csv(cf_by_reg, file.path(out_dir, sprintf("B6_counterfactual_%d_by_region.csv", cf_year)))
}

# ---------------- 性能可视化与面板 ----------------
perf_sum <- preds_tbl %>%
  group_by(grow_year) %>%
  summarise(n=n(),
            RMSE = sqrt(mean((y_true - y_pred)^2)),
            MAE  = mean(abs(y_true - y_pred)),
            Bias = mean(y_true - y_pred),
            R2   = if (sd(y_true) > 0) cor(y_true, y_pred)^2 else NA_real_,
            .groups = "drop") %>% arrange(grow_year)
readr::write_csv(perf_sum, file.path(out_dir, "B0_LOYO_perf_xgb.csv"))

p_rmse <- ggplot(perf_sum, aes(x=grow_year, y=RMSE)) +
  geom_line(linewidth=0.7) + geom_point(size=1.6) +
  labs(x="Year", y="RMSE (p.p.)") + nature_theme_light(base_size = 11)
p_r2 <- ggplot(perf_sum, aes(x=grow_year, y=R2)) +
  geom_line(linewidth=0.7) + geom_point(size=1.6) +
  scale_y_continuous(limits=c(0,1)) +
  labs(x="Year", y=expression(R^2)) + nature_theme_light(base_size = 11)
p_scatter <- ggplot(preds_tbl, aes(x = y_pred, y = y_true)) +
  geom_abline(slope=1, intercept=0, linetype="dashed", color="grey50") +
  geom_point(alpha=0.45, size=0.8) +
  facet_wrap(~ grow_year, ncol = min(5, ceiling(sqrt(dplyr::n_distinct(preds_tbl$grow_year))))) +
  labs(x="Predicted anomaly (p.p.)", y="Observed anomaly (p.p.)") + nature_theme_light(base_size = 10)
p_resid <- ggplot(preds_tbl, aes(x = y_true - y_pred)) +
  geom_histogram(bins = 40, fill="#9ecae1", color="white") +
  geom_vline(xintercept = 0, linetype="dashed", color="grey50") +
  labs(x="Residual (observed − predicted, p.p.)", y="Count") + nature_theme_light(base_size = 11)
prov_n <- preds_tbl %>% count(Province, sort=TRUE); top_prov <- prov_n %>% slice_head(n=20) %>% pull(Province)
p_box <- preds_tbl %>% filter(Province %in% top_prov) %>%
  ggplot(aes(x=reorder(Province, y_true - y_pred, FUN=median), y=y_true - y_pred)) +
  geom_boxplot(outlier.shape = 16, outlier.size = 0.6) + coord_flip() +
  labs(x="Province", y="Residual (p.p.)") + nature_theme_light(base_size = 10)

save_figure_pub(p_rmse,   "B0_perf_RMSE_timeseries", width=6.8, height=3.2, dpi=600)
save_figure_pub(p_r2,     "B0_perf_R2_timeseries",   width=6.8, height=3.2, dpi=600)
save_figure_pub(p_scatter,"B0_obs_vs_pred_facets",   width=9.5, height=6.5, dpi=600)
save_figure_pub(p_resid,  "B0_residual_hist",       width=6.4, height=3.4, dpi=600)
save_figure_pub(p_box,    "B0_residual_box_by_province", width=7.2, height=6.8, dpi=600)

row1 <- cowplot::plot_grid(p_rmse, p_r2, ncol = 2, labels = c("a","b"),
                           label_size = 12, label_fontface = "bold",
                           label_x = 0.01, label_y = 0.99, hjust = 0, vjust = 1)
row2 <- cowplot::plot_grid(p_scatter, ncol = 1, labels = "c",
                           label_size = 12, label_fontface = "bold",
                           label_x = 0.01, label_y = 0.99, hjust = 0, vjust = 1)
row3 <- cowplot::plot_grid(p_resid, p_box, ncol = 2, labels = c("d","e"),
                           label_size = 12, label_fontface = "bold",
                           label_x = 0.01, label_y = 0.99, hjust = 0, vjust = 1)
panel_perf <- cowplot::plot_grid(row1, row2, row3, ncol = 1, rel_heights = c(0.75, 1.2, 0.9))
save_figure_pub(panel_perf, "B0_perf_PANEL_main", width = 7.6, height = 9.6, dpi = 600)

# ---------------- Session info ----------------
sink(file.path(out_dir, "B0_sessionInfo.txt")); sessionInfo(); sink()

cat("\n✅ 全年份建模与归因完成。\n",
    "- 性能：          ", file.path(out_dir, "B0_LOYO_perf_xgb.csv"), "\n",
    "- 逐样本预测：    ", file.path(out_dir, "B0_LOYO_predictions.csv"), "\n",
    "- 年-特征 SHAP：  ", file.path(out_dir, "B2_year_feature_SHAP.csv"), "\n",
    "- 省/县归因表：   ", file.path(out_dir, "B3_year_province_feature_SHAP.csv"), " / ",
                          file.path(out_dir, "B4_year_county_feature_SHAP.csv"), "\n",
    "- 全局关键因子：  ", file.path(out_dir, "B8_global_SHAP_importance_all_years.csv"), "\n",
    "- 家族份额：      ", file.path(out_dir, "B9_family_share_global_meanAbsSHAP.csv"), " / ",
                          file.path(out_dir, "B9_family_share_global_negativeSHAP.csv"), "\n",
    "- 稳定性：        ", file.path(out_dir, "B11_yearly_top10_frequency.csv"), "\n",
    "- 可视化：        ", file.path(plots_dir, "B5/B7/B9/B10/B0_*"), "\n",
    "- 反事实恢复：    ", file.path(out_dir, sprintf("B6_counterfactual_%d_by_province.csv", cf_year)), " / ..._by_region.csv\n")
